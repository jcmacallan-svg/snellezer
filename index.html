<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RSVP Reader â€“ 3â€‘Pane</title>

<style>
/* =========================
   CORE THEME / LAYOUT
   ========================= */
:root{
  --bg:#0d1117; --panel:#161b22; --text:#e6edf3; --muted:#9ba3af; --accent:#ff4d4d;
  --field:#0b1220; --border:#2b2b2b;

  --sidebarW: 340px;
  --readerW: 38%;
  --dividerW: 10px;

  --fontPx: 72px;
  --pivotGap: 8px;
}
*{ box-sizing:border-box; }
body{
  margin:0; background:var(--bg); color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,system-ui,sans-serif;
  overflow:hidden;
}
#app{ height:100vh; display:flex; overflow:hidden; }

/* =========================
   SIDEBAR
   ========================= */
#sidebar{
  width:var(--sidebarW); min-width:260px; max-width:520px;
  background:var(--panel); border-right:1px solid var(--border);
  display:flex; flex-direction:column; overflow:hidden;
}
#sideTop{ height:44px; display:flex; align-items:center; gap:10px; padding:10px 12px; border-bottom:1px solid var(--border); }
#burger{ width:32px; height:28px; border:1px solid var(--border); border-radius:8px; background:transparent; color:var(--text); cursor:pointer; }
#burger:hover{ border-color:var(--accent); }
#sideTitle{ font-weight:700; font-size:13px; }
#sideScroll{ padding:12px; overflow:auto; }
.group{ border:1px solid #222; border-radius:12px; padding:10px; margin:10px 0; background:#0f1524; }
.gtitle{ font-size:12px; font-weight:700; margin-bottom:6px; }
label{ font-size:11px; color:var(--muted); display:block; margin:8px 0 4px; }
input,button{ font:inherit; }
input{ width:100%; background:var(--field); color:var(--text); border:1px solid var(--border); border-radius:10px; padding:8px; }
button{ background:transparent; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:8px; cursor:pointer; }
button:hover{ border-color:var(--accent); }
.hint{ font-size:11px; color:var(--muted); }

/* =========================
   MAIN / RSVP
   ========================= */
#main{ flex:1; display:flex; overflow:hidden; }
#readerPane{ flex:0 0 var(--readerW); display:flex; align-items:center; justify-content:center; }
#rsvpBox{ display:grid; grid-template-columns:1fr auto 1fr; align-items:center; }
#leftText,#pivot,#rightText{
  font-size:var(--fontPx); font-weight:650; line-height:1; white-space:nowrap;
}
#leftText{ text-align:right; padding-right:var(--pivotGap); }
#pivot{ color:var(--accent); }
#rightText{ text-align:left; padding-left:var(--pivotGap); }

#splitter{ flex:0 0 var(--dividerW); cursor:col-resize; background:rgba(255,255,255,.05); }

/* =========================
   PREVIEW
   ========================= */
#previewPane{ flex:1; background:#0b0f17; display:flex; flex-direction:column; }
#previewTop{ height:40px; border-bottom:1px solid var(--border); padding:8px; font-size:12px; color:var(--muted); }
#previewBody{ flex:1; overflow:auto; padding:12px; display:flex; justify-content:center; }
canvas{ background:#fff; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.4); }

#statusbar{ height:32px; background:var(--panel); border-top:1px solid var(--border); display:flex; gap:12px; align-items:center; padding:0 10px; font-size:12px; color:var(--muted); }
.pill{ padding:4px 10px; border-radius:999px; border:1px solid #222; background:#0f1524; }
</style>
</head>
<body>
<div id="app">
  <aside id="sidebar">
    <div id="sideTop">
      <button id="burger">â˜°</button>
      <div id="sideTitle">RSVP Reader</div>
    </div>
    <div id="sideScroll">
      <div class="group">
        <div class="gtitle">Open PDF</div>
        <input id="fileInput" type="file" accept="application/pdf" />
        <div class="hint">Local PDF only (browserâ€‘side)</div>
      </div>
      <div class="group">
        <div class="gtitle">Speed</div>
        <label>Words per minute</label>
        <input id="wpm" type="number" value="600" min="100" max="900" />
      </div>
      <div class="group">
        <button id="startBtn">Start</button>
        <button id="pauseBtn">Pause</button>
        <button id="resetBtn">Reset</button>
      </div>
      <div class="group">
        <button id="diagBtn">ðŸ©º Health check</button>
      </div>
    </div>
  </aside>

  <section id="main">
    <section id="readerPane">
      <div id="rsvpBox">
        <div id="leftText"></div>
        <div id="pivot"></div>
        <div id="rightText"></div>
      </div>
    </section>
    <div id="splitter"></div>
    <aside id="previewPane">
      <div id="previewTop">PDF Preview</div>
      <div id="previewBody"><canvas id="canvas"></canvas></div>
    </aside>
  </section>
</div>

<div id="statusbar">
  <span class="pill" id="fileStatus">No PDF</span>
  <span class="pill" id="pageStatus">Page â€“</span>
  <span class="pill" id="wordStatus">Word â€“</span>
</div>

<div id="diagModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6);">
  <div style="margin:10vh auto; width:90%; max-width:800px; background:#0f1524; border-radius:12px; padding:14px;">
    <button id="diagClose">Close</button>
    <pre id="diagBody" style="font-size:12px; color:#9ba3af;"></pre>
  </div>
</div>

<script type="module">
import * as pdfjsLib from './pdf.mjs';
pdfjsLib.GlobalWorkerOptions.workerSrc = './pdf.worker.mjs';

const fileInput = document.getElementById('fileInput');
const leftText = document.getElementById('leftText');
const pivot = document.getElementById('pivot');
const rightText = document.getElementById('rightText');
const wpmEl = document.getElementById('wpm');
const startBtn = document.getElementById('startBtn');
const pauseBtn = document.getElementById('pauseBtn');
const resetBtn = document.getElementById('resetBtn');
const fileStatus = document.getElementById('fileStatus');
const pageStatus = document.getElementById('pageStatus');
const wordStatus = document.getElementById('wordStatus');

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let pdf=null, words=[], idx=0, paused=true, timer=null;

function orp(word){ if(word.length<=1) return 0; if(word.length<=5) return 1; if(word.length<=9) return 2; if(word.length<=13) return 3; return 4; }
function renderWord(w){ const i=orp(w); leftText.textContent=w.slice(0,i); pivot.textContent=w[i]||''; rightText.textContent=w.slice(i+1); }
function delay(){ return 60000/Math.max(100,Math.min(900,Number(wpmEl.value))); }

async function tick(){ if(paused) return; if(idx>=words.length){ paused=true; return; } const w=words[idx++]; renderWord(w); wordStatus.textContent=`Word ${idx}/${words.length}`; timer=setTimeout(tick,delay()); }

fileInput.addEventListener('change', async ()=>{
  const f=fileInput.files[0]; if(!f) return;
  const buf=await f.arrayBuffer();
  pdf=await pdfjsLib.getDocument({data:buf}).promise;
  const page=await pdf.getPage(1);
  const txt=await page.getTextContent();
  words=txt.items.flatMap(i=>i.str.split(/\s+/)); idx=0;
  fileStatus.textContent=f.name; pageStatus.textContent='Page 1'; renderWord('Ready');
});

startBtn.onclick=()=>{ if(!pdf) return; paused=false; tick(); };
pauseBtn.onclick=()=>{ paused=true; clearTimeout(timer); };
resetBtn.onclick=()=>{ paused=true; clearTimeout(timer); idx=0; renderWord('Reset'); };

// Diagnostics
const diagBtn=document.getElementById('diagBtn');
const diagModal=document.getElementById('diagModal');
const diagBody=document.getElementById('diagBody');
const diagClose=document.getElementById('diagClose');

diagBtn.onclick=()=>{
  diagBody.textContent=
`RSVP Reader Diagnostics
======================
URL: ${location.href}
Protocol: ${location.protocol}
UserAgent: ${navigator.userAgent}
pdf.js version: ${pdfjsLib.version}
PDF loaded: ${!!pdf}`;
  diagModal.style.display='block';
};
diagClose.onclick=()=>diagModal.style.display='none';
</script>
</body>
</html>
